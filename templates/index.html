<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ÖZCAN OTO PRO | YEDEKLEME MERKEZİ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; display: flex; margin: 0; }
        #login-screen { position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .sidebar { background: #0f172a; width: 280px; min-height: 100vh; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .page-content { display: none; padding: 40px; width: 100%; height: 100vh; overflow-y: auto; }
        .active-section { display: block; }
        .sidebar-link { padding: 14px 20px; cursor: pointer; color: #94a3b8; border-radius: 10px; margin: 4px 15px; display: block; transition: 0.3s; }
        .sidebar-link:hover { background: #1e293b; color: white; }
        .sidebar-active { background: #f97316 !important; color: white !important; font-weight: bold; }
        .btn-action { padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 11px; text-transform: uppercase; cursor: pointer; }
        #main-layout { display: none; width: 100%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-96 text-center">
            <h1 class="text-3xl font-black italic mb-2">ÖZCAN OTO</h1>
            <button onclick="checkLogin()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl mt-4">GİRİŞ YAP</button>
        </div>
    </div>

    <input type="file" id="import-file" class="hidden" onchange="processImport(this)">

    <div id="main-layout">
        <aside class="sidebar">
            <div class="p-8 border-b border-slate-800 text-center">
                <h1 class="text-2xl font-black italic text-white">ÖZCAN OTO</h1>
            </div>
            <nav class="mt-6 flex-1">
                <div onclick="showPage('dashboard')" id="btn-dashboard" class="sidebar-link sidebar-active"><i class="fas fa-home mr-3"></i> Dashboard</div>
                <div onclick="showPage('stok')" id="btn-stok" class="sidebar-link"><i class="fas fa-boxes mr-3"></i> Parça Yönetimi</div>
                <div onclick="showPage('fatura')" id="btn-fatura" class="sidebar-link"><i class="fas fa-file-invoice mr-3"></i> Satışlar</div>
                <div onclick="showPage('veresiye')" id="btn-veresiye" class="sidebar-link"><i class="fas fa-hand-holding-usd mr-3"></i> Veresiye</div>
                <div onclick="showPage('gider')" id="btn-gider" class="sidebar-link"><i class="fas fa-wallet mr-3"></i> Giderler</div>
                <div onclick="showPage('cari')" id="btn-cari" class="sidebar-link"><i class="fas fa-users mr-3"></i> Cari Rehber</div>
            </nav>
        </aside>

        <main class="flex-1">
            <div id="page-dashboard" class="page-content active-section">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-3xl font-black italic uppercase">Sistem Özeti</h2>
                    <button onclick="sifirlaFinans()" class="bg-red-600 text-white px-6 py-3 rounded-2xl font-bold text-xs uppercase shadow-lg">
                        <i class="fas fa-sync-alt mr-2"></i> Finans Sıfırla
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-emerald-500">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Toplam Kazanç</p>
                        <h3 id="dash-kazanc" class="text-3xl font-black text-emerald-600">₺0.00</h3>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-red-500">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Toplam Gider</p>
                        <h3 id="dash-gider" class="text-3xl font-black text-red-600">₺0.00</h3>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-sm border-l-8 border-blue-600">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Toplam Parça Değeri</p>
                        <h3 id="dash-deger" class="text-3xl font-black text-slate-800">****</h3>
                        <button onclick="hesaplaStokDegeri()" class="mt-4 text-[10px] bg-blue-50 text-blue-600 px-4 py-2 rounded-full font-bold uppercase">Hesapla / Göster</button>
                    </div>
                </div>
            </div>

            <div id="page-stok" class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black italic uppercase">Parça Yönetimi</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData('products')" class="bg-green-600 text-white btn-action">Excel (TXT) İndir</button>
                        <button onclick="triggerImport('products')" class="bg-blue-600 text-white btn-action">Geri Yükle</button>
                    </div>
                </div>
                <div id="stok-alanlari">... (Stok Tablosu Buraya Gelecek) ...</div>
            </div>

            <div id="page-cari" class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black italic uppercase">Cari Rehber</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData('customers')" class="bg-green-600 text-white btn-action">Excel (TXT) İndir</button>
                        <button onclick="triggerImport('customers')" class="bg-blue-600 text-white btn-action">Geri Yükle</button>
                    </div>
                </div>
                <div id="cari-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            </main>
    </div>

    <script>
        let allProducts = [];
        let activeImportType = '';

        function checkLogin() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-layout').style.display = 'flex';
            loadDashboard();
        }

        function showPage(pId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active-section'));
            document.getElementById('page-' + pId).classList.add('active-section');
            if(pId === 'dashboard') loadDashboard();
            if(pId === 'cari') yukleCari();
            if(pId === 'stok') yukleStok();
        }

        // --- DASHBOARD FONKSİYONLARI ---
        async function loadDashboard() {
            const res = await fetch('/api/dashboard-stats');
            const data = await res.json();
            // TL işaretini teke düşürdük
            document.getElementById('dash-kazanc').innerText = "₺" + data.kazanc.toLocaleString('tr-TR');
            document.getElementById('dash-gider').innerText = "₺" + data.gider.toLocaleString('tr-TR');
        }

        async function sifirlaFinans() {
            if(confirm("Tüm satış ve gider kayıtları silinecek. Emin misiniz?")) {
                const res = await fetch('/api/reset-finance', { method: 'POST' });
                const data = await res.json();
                if(data.ok) {
                    alert("Finansal veriler sıfırlandı.");
                    loadDashboard();
                }
            }
        }

        async function hesaplaStokDegeri() {
            const res = await fetch('/api/products');
            const products = await res.json();
            let toplam = 0;
            products.forEach(p => {
                let fiyat = parseFloat(String(p.price).replace('₺','').replace('.','').replace(',','.')) || 0;
                toplam += (fiyat * (parseInt(p.stock) || 0));
            });
            document.getElementById('dash-deger').innerText = "₺" + toplam.toLocaleString('tr-TR');
        }

        // --- EXCEL (TXT) VE GERİ YÜKLEME ---
        async function exportData(col) {
            const res = await fetch(`/api/${col}`);
            const data = await res.json();
            let content = "";
            
            if(col === 'products') {
                content = "Ad;Kod;Kategori;Fiyat;Stok\n";
                data.forEach(i => content += `${i.name};${i.code};${i.category};${i.price};${i.stock}\n`);
            } else if(col === 'customers') {
                content = "Müşteri Adı;Telefon\n";
                data.forEach(i => content += `${i.ad};${i.tel}\n`);
            }
            
            const blob = new Blob(["\ufeff" + content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `OzcanOto_${col}_Yedek.txt`;
            link.click();
        }

        function triggerImport(type) {
            activeImportType = type;
            document.getElementById('import-file').click();
        }

        async function processImport(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').slice(1); // Başlığı atla
                for(let line of lines) {
                    if(!line.trim()) continue;
                    const p = line.split(';');
                    let payload = {};
                    if(activeImportType === 'products') {
                        payload = { name: p[0], code: p[1], category: p[2], price: p[3], stock: p[4] };
                    } else if(activeImportType === 'customers') {
                        payload = { ad: p[0], tel: p[1] };
                    }
                    await fetch(`/api/${activeImportType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                alert("Yükleme başarıyla tamamlandı.");
                showPage(activeImportType === 'products' ? 'stok' : 'cari');
            };
            reader.readAsText(input.files[0]);
            input.value = ''; // Reset input
        }

        // --- DİĞER YÜKLEME FONKSİYONLARI ---
        async function yukleCari() {
            const res = await fetch('/api/customers');
            const data = await res.json();
            document.getElementById('cari-list').innerHTML = data.map(c => `
                <div class="bg-white p-5 rounded-2xl border flex justify-between items-center shadow-sm">
                    <div><h4 class="font-black">${c.ad}</h4><p class="text-xs text-slate-500">${c.tel}</p></div>
                    <i class="fas fa-user text-slate-200 text-xl"></i>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
