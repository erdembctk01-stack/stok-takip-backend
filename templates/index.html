<script>
        /**
         * 1. STOK YÖNETİM MODÜLÜ
         * Parça listeleme ve silme işlemlerinden sorumludur.
         */
        const StokModulu = {
            async yukle() {
                try {
                    const res = await fetch('/api/products');
                    const data = await res.json();
                    this.tabloyuCiz(data);
                } catch (hata) {
                    console.error("Stok yüklenirken hata:", hata);
                }
            },
            tabloyuCiz(data) {
                const liste = document.getElementById('stok-list');
                if(!liste) return;
                liste.innerHTML = data.reverse().map(i => `
                    <tr class="border-t">
                        <td class="p-4 font-bold uppercase">${i.name}</td>
                        <td class="p-4 text-center">${i.stock}</td>
                        <td class="p-4 text-right">₺${i.price}</td>
                        <td class="p-4 text-right">
                            <button onclick="StokModulu.sil('${i._id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            },
            async sil(id) {
                if(!confirm('Bu parçayı silmek istediğinize emin misiniz?')) return;
                await fetch(`/api/products/${id}`, {method: 'DELETE'});
                this.yukle(); // Sadece stok listesini yeniler
            }
        };

        /**
         * 2. SATIŞ VE FATURA MODÜLÜ
         * Yeni satış yapma ve stoktan düşme işlemlerinden sorumludur.
         */
        const FaturaModulu = {
            async gonder() {
                const form = {
                    ad: document.getElementById('fat-ad').value,
                    parcaId: document.getElementById('fat-parca').value,
                    adet: document.getElementById('fat-adet').value,
                    tarih: new Date().toLocaleString('tr-TR')
                };

                if(!form.ad || !form.adet) return alert("Lütfen boş alan bırakmayın!");

                const res = await fetch('/api/fatura-kes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(form)
                });

                if(res.ok) {
                    alert("Satış başarıyla kaydedildi.");
                    StokModulu.yukle(); // Satış sonrası stok listesini de günceller
                }
            }
        };

        /**
         * 3. RAPORLAMA MODÜLÜ
         * Excel indirme ve veri dışa aktarma işlemlerinden sorumludur.
         */
        const RaporModulu = {
            async excelIndir(tip) {
                const res = await fetch(`/api/${tip}`);
                const data = await res.json();
                const bugun = new Date().toLocaleDateString('tr-TR');
                
                let satirlar = [["ÖZCAN OTO RAPOR - " + bugun], []];
                data.forEach(i => {
                    satirlar.push(["PARÇA: " + (i.name || i.parca_ad)]);
                    satirlar.push(["MİKTAR: " + (i.stock || i.adet)]);
                    satirlar.push(["------------------"]);
                });

                const ws = XLSX.utils.aoa_to_sheet(satirlar);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rapor");
                XLSX.writeFile(wb, `OzcanOto_${tip}_${bugun}.xlsx`);
            }
        };

        /**
         * SAYFA KONTROLÜ
         */
        function showPage(p) {
            document.querySelectorAll('.page-content').forEach(x => x.classList.remove('active-section'));
            document.getElementById('page-' + p).classList.add('active-section');
            
            // Sayfa açıldığında ilgili modülü çalıştır
            if(p === 'stok') StokModulu.yukle();
        }
    </script>
