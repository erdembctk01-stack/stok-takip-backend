<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ÖZCAN OTO PRO | YEDEKLEME MERKEZİ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; display: flex; margin: 0; }
        #login-screen { position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .sidebar { background: #0f172a; width: 280px; min-height: 100vh; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .page-content { display: none; padding: 40px; width: 100%; height: 100vh; overflow-y: auto; }
        .active-section { display: block; }
        .sidebar-link { padding: 14px 20px; cursor: pointer; color: #94a3b8; border-radius: 10px; margin: 4px 15px; display: block; transition: 0.3s; }
        .sidebar-link:hover { background: #1e293b; color: white; }
        .sidebar-link.active { background: #3b82f6; color: white; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); padding: 24px; }
        .btn-primary { background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; transition: 0.2s; }
        .btn-primary:hover { background: #2563eb; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 5px; outline: none; }
        input:focus { border-color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; text-align: left; padding: 12px; color: #64748b; font-size: 0.875rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #1e293b; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 500px; max-width: 90%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Yönetici Girişi</h2>
            <input type="password" id="login-pass" placeholder="Şifre giriniz..." class="mb-4">
            <button onclick="checkLogin()" class="w-full btn-primary">Giriş Yap</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="p-6 mb-4">
            <h1 class="text-xl font-bold text-white tracking-tight">ÖZCAN OTO PRO</h1>
            <p class="text-xs text-slate-400">Gelişmiş Stok & Finans</p>
        </div>
        <div class="sidebar-link active" onclick="showSection('dashboard')"><i class="fas fa-chart-line mr-3"></i> Panel</div>
        <div class="sidebar-link" onclick="showSection('stok')"><i class="fas fa-boxes mr-3"></i> Parça Yönetimi</div>
        <div class="sidebar-link" onclick="showSection('fatura')"><i class="fas fa-file-invoice-dollar mr-3"></i> Satış & Fatura</div>
        <div class="sidebar-link" onclick="showSection('gider')"><i class="fas fa-wallet mr-3"></i> Gider Takibi</div>
        <div class="sidebar-link" onclick="showSection('musteri')"><i class="fas fa-users mr-3"></i> Müşteri Listesi</div>
        <div class="sidebar-link" onclick="showSection('yedek')"><i class="fas fa-database mr-3"></i> Yedekleme</div>
    </div>

    <div id="dashboard" class="page-content active-section">
        <h2 class="text-3xl font-bold mb-8 text-slate-800">Genel Bakış</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card border-l-4 border-blue-500">
                <p class="text-sm text-slate-500 font-medium">Toplam Kazanç</p>
                <h3 id="stat-kazanc" class="text-2xl font-bold text-slate-800">₺0.00</h3>
            </div>
            <div class="card border-l-4 border-red-500">
                <p class="text-sm text-slate-500 font-medium">Toplam Gider</p>
                <h3 id="stat-gider" class="text-2xl font-bold text-slate-800">₺0.00</h3>
            </div>
            <div class="card border-l-4 border-green-500">
                <p class="text-sm text-slate-500 font-medium">Net Kar</p>
                <h3 id="stat-kar" class="text-2xl font-bold text-slate-800">₺0.00</h3>
            </div>
            <div class="card border-l-4 border-purple-500">
                <p class="text-sm text-slate-500 font-medium">Stoktaki Parça</p>
                <h3 id="stat-stok" class="text-2xl font-bold text-slate-800">0 Adet</h3>
            </div>
        </div>
    </div>

    <div id="stok" class="page-content">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800">Parça Yönetimi</h2>
            <button onclick="document.getElementById('modal-parca').style.display='flex'" class="btn-primary">
                <i class="fas fa-plus mr-2"></i> Yeni Parça Ekle
            </button>
        </div>
        <div class="card">
            <input type="text" id="stok-ara" onkeyup="tabloAra('stok-tablo', this.value)" placeholder="Parça adı veya kodu ile ara..." class="mb-6">
            <table id="stok-tablo">
                <thead>
                    <tr>
                        <th>Kod</th>
                        <th>Parça Adı</th>
                        <th>Kategori</th>
                        <th>Stok</th>
                        <th>Fiyat</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="stok-listesi"></tbody>
            </table>
        </div>
    </div>

    <div id="fatura" class="page-content">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800">Satış & Fatura Kes</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="card md:col-span-1">
                <h3 class="font-bold mb-4 text-slate-700">Müşteri Bilgileri</h3>
                <input type="text" id="f-ad" placeholder="Müşteri Ad Soyad" class="mb-4">
                <input type="text" id="f-tel" placeholder="Telefon No" class="mb-4">
                <input type="date" id="f-tarih" class="mb-4">
                <hr class="my-6">
                <h3 class="font-bold mb-4 text-slate-700">Parça Ekle</h3>
                <select id="f-parca-sec" class="mb-4"></select>
                <input type="number" id="f-adet" value="1" min="1" class="mb-4">
                <button onclick="sepeteEkle()" class="w-full bg-slate-800 text-white p-3 rounded-lg hover:bg-slate-700 transition">Sepete Ekle</button>
            </div>
            <div class="card md:col-span-2">
                <h3 class="font-bold mb-4 text-slate-700">Sepet Detayı</h3>
                <table class="mb-6">
                    <thead>
                        <tr>
                            <th>Parça</th>
                            <th>Adet</th>
                            <th>Birim Fiyat</th>
                            <th>Toplam</th>
                            <th>Sil</th>
                        </tr>
                    </thead>
                    <tbody id="sepet-listesi"></tbody>
                </table>
                <div class="flex justify-between items-center pt-4 border-t">
                    <span class="text-xl font-bold text-slate-800">Genel Toplam: <span id="sepet-toplam">₺0.00</span></span>
                    <button onclick="faturaKes()" class="btn-primary px-8">Satışı Tamamla & Fatura Kes</button>
                </div>
            </div>
        </div>
        <div class="card mt-8">
            <h3 class="font-bold mb-4 text-slate-700 text-lg">Geçmiş Faturalar</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Müşteri</th>
                        <th>Parçalar</th>
                        <th>Toplam</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody id="fatura-listesi"></tbody>
            </table>
        </div>
    </div>

    <div id="gider" class="page-content">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800">Gider Takibi</h2>
            <button onclick="document.getElementById('modal-gider').style.display='flex'" class="btn-primary">Yeni Gider Ekle</button>
        </div>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Açıklama</th>
                        <th>Kategori</th>
                        <th>Tutar</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody id="gider-listesi"></tbody>
            </table>
        </div>
    </div>

    <div id="musteri" class="page-content">
        <h2 class="text-3xl font-bold mb-8 text-slate-800">Müşteri Listesi</h2>
        <div class="card">
            <input type="text" onkeyup="tabloAra('musteri-tablo', this.value)" placeholder="Müşteri ara..." class="mb-6">
            <table id="musteri-tablo">
                <thead>
                    <tr>
                        <th>Ad Soyad</th>
                        <th>Telefon</th>
                        <th>Son İşlem Tarihi</th>
                        <th>Detay</th>
                    </tr>
                </thead>
                <tbody id="musteri-listesi"></tbody>
            </table>
        </div>
    </div>

    <div id="yedek" class="page-content">
        <h2 class="text-3xl font-bold mb-8 text-slate-800">Sistem Yedekleme</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="card">
                <h3 class="font-bold mb-4">Veri Dışa Aktar (Yedek Al)</h3>
                <div class="space-y-4">
                    <button onclick="exportExcel('products')" class="w-full text-left p-4 bg-slate-50 rounded-lg hover:bg-slate-100"><i class="fas fa-file-export mr-3 text-blue-500"></i> Parça Listesini Yedekle (.txt)</button>
                    <button onclick="exportExcel('invoices')" class="w-full text-left p-4 bg-slate-50 rounded-lg hover:bg-slate-100"><i class="fas fa-file-export mr-3 text-green-500"></i> Fatura Geçmişini Yedekle (.txt)</button>
                    <button onclick="exportExcel('expenses')" class="w-full text-left p-4 bg-slate-50 rounded-lg hover:bg-slate-100"><i class="fas fa-file-export mr-3 text-red-500"></i> Gider Kayıtlarını Yedekle (.txt)</button>
                </div>
            </div>
            <div class="card">
                <h3 class="font-bold mb-4">Veri İçe Aktar (Yedekten Dön)</h3>
                <div class="space-y-4">
                    <button onclick="triggerImport('products')" class="w-full text-left p-4 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-medium">Stok Verilerini Yükle</button>
                    <button onclick="if(confirm('TÜM FİNANSAL VERİLER SIFIRLANACAK! Emin misiniz?')) resetFinance()" class="w-full text-left p-4 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 font-medium text-center">Tüm Finans Verilerini Sıfırla</button>
                </div>
                <input type="file" id="import-file" class="hidden" onchange="processImport(this)">
            </div>
        </div>
    </div>

    <div id="modal-parca" class="modal">
        <div class="modal-content">
            <h3 id="modal-parca-baslik" class="text-xl font-bold mb-6">Yeni Parça Ekle</h3>
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="p-name" placeholder="Parça Adı" class="col-span-2">
                <input type="text" id="p-code" placeholder="Parça Kodu">
                <input type="text" id="p-cat" placeholder="Kategori">
                <input type="number" id="p-stock" placeholder="Stok Miktarı">
                <input type="text" id="p-price" placeholder="Birim Fiyat (₺)">
            </div>
            <textarea id="p-desc" placeholder="Parça Açıklaması" class="mt-4 h-24"></textarea>
            <input type="text" id="p-compat" placeholder="Uyumlu Modeller" class="mt-4">
            <div class="flex justify-end space-x-4 mt-8">
                <button onclick="closeModals()" class="px-6 py-2 text-slate-500 font-medium">İptal</button>
                <button onclick="parcaKaydet()" class="btn-primary">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="modal-gider" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-6">Yeni Gider Kaydı</h3>
            <input type="date" id="g-tarih" class="mb-4">
            <input type="text" id="g-desc" placeholder="Gider Açıklaması" class="mb-4">
            <input type="text" id="g-cat" placeholder="Kategori" class="mb-4">
            <input type="text" id="g-tutar" placeholder="Tutar (₺)" class="mb-4">
            <div class="flex justify-end space-x-4 mt-8">
                <button onclick="closeModals()" class="px-6 py-2 text-slate-500 font-medium">İptal</button>
                <button onclick="giderEkle()" class="btn-primary">Gideri Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        let sepet = [];
        let parcalar = [];
        let activeImportType = '';

        function checkLogin() {
            if(document.getElementById('login-pass').value === '123') {
                document.getElementById('login-screen').style.display = 'none';
                init();
            } else { alert("Hatalı şifre!"); }
        }

        function showSection(id) {
            document.querySelectorAll('.page-content').forEach(s => s.classList.remove('active-section'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            event.currentTarget.classList.add('active');
            if(id === 'stok') yukleStok();
            if(id === 'fatura') { yukleStok(); yukleFaturalar(); }
            if(id === 'gider') yukleGiderler();
            if(id === 'musteri') yukleMusteriler();
            if(id === 'dashboard') yukleStats();
        }

        async function init() { yukleStats(); yukleStok(); }

        async function yukleStats() {
            const res = await fetch('/api/dashboard-stats');
            const data = await res.json();
            document.getElementById('stat-kazanc').innerText = `₺${data.kazanc.toLocaleString()}`;
            document.getElementById('stat-gider').innerText = `₺${data.gider.toLocaleString()}`;
            document.getElementById('stat-kar').innerText = `₺${data.kar.toLocaleString()}`;
            document.getElementById('stat-stok').innerText = `${data.stok_adet} Adet`;
        }

        async function yukleStok() {
            const res = await fetch('/api/products');
            parcalar = await res.json();
            const liste = document.getElementById('stok-listesi');
            const select = document.getElementById('f-parca-sec');
            liste.innerHTML = ''; select.innerHTML = '';

            parcalar.forEach(p => {
                liste.innerHTML += `
                    <tr>
                        <td class="font-mono text-xs">${p.code}</td>
                        <td class="font-bold">${p.name}</td>
                        <td><span class="bg-slate-100 px-2 py-1 rounded text-xs">${p.category}</span></td>
                        <td class="${p.stock < 5 ? 'text-red-500 font-bold' : ''}">${p.stock}</td>
                        <td>₺${p.price}</td>
                        <td>
                            <button onclick="parcaDuzenleAc('${p._id}')" class="text-blue-500 mr-3 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                            <button onclick="parcaSil('${p._id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                select.innerHTML += `<option value="${p._id}">${p.name} (${p.code}) - ₺${p.price}</option>`;
            });
        }

        // DÜZENLEME BUTONU GELİŞTİRMESİ
        function parcaDuzenleAc(id) {
            const p = parcalar.find(item => item._id === id);
            if(!p) return;
            
            document.getElementById('modal-parca-baslik').innerText = "Parçayı Düzenle";
            document.getElementById('edit-id').value = p._id;
            
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-code').value = p.code;
            document.getElementById('p-cat').value = p.category;
            document.getElementById('p-stock').value = p.stock; // Kullanıcı stoğu da buradan güncelleyebilir
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-desc').value = p.desc || '';
            document.getElementById('p-compat').value = p.compat || '';
            
            document.getElementById('modal-parca').style.display = 'flex';
        }

        async function parcaKaydet() {
            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('p-name').value,
                code: document.getElementById('p-code').value,
                category: document.getElementById('p-cat').value,
                stock: parseInt(document.getElementById('p-stock').value),
                price: document.getElementById('p-price').value,
                desc: document.getElementById('p-desc').value,
                compat: document.getElementById('p-compat').value
            };

            // Eğer ID varsa düzenleme (edit) API'sine, yoksa ekleme API'sine gider
            const url = id ? `/api/products/edit/${id}` : '/api/products';
            
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if(res.ok) {
                closeModals();
                yukleStok();
            }
        }

        async function parcaSil(id) {
            if(confirm('Bu parçayı silmek istediğinize emin misiniz?')) {
                await fetch(`/api/products/${id}`, {method: 'DELETE'});
                yukleStok();
            }
        }

        function sepeteEkle() {
            const sId = document.getElementById('f-parca-sec').value;
            const adet = parseInt(document.getElementById('f-adet').value);
            const parca = parcalar.find(p => p._id === sId);
            if(adet > parca.stock) { alert("Yetersiz stok!"); return; }
            const varMi = sepet.find(s => s.parcaId === sId);
            if(varMi) { varMi.adet += adet; } 
            else {
                sepet.push({
                    parcaId: sId,
                    name: parca.name,
                    adet: adet,
                    fiyat: parseFloat(parca.price)
                });
            }
            guncelleSepet();
        }

        function guncelleSepet() {
            const liste = document.getElementById('sepet-listesi');
            liste.innerHTML = '';
            let toplam = 0;
            sepet.forEach((s, index) => {
                const t = s.adet * s.fiyat;
                toplam += t;
                liste.innerHTML += `<tr><td>${s.name}</td><td>${s.adet}</td><td>₺${s.fiyat}</td><td>₺${t}</td><td><button onclick="sepettenSil(${index})" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });
            document.getElementById('sepet-toplam').innerText = `₺${toplam.toFixed(2)}`;
        }

        function sepettenSil(i) { sepet.splice(i, 1); guncelleSepet(); }

        async function faturaKes() {
            const data = {
                ad: document.getElementById('f-ad').value,
                tel: document.getElementById('f-tel').value,
                tarih: document.getElementById('f-tarih').value,
                items: sepet
            };
            if(!data.ad || sepet.length === 0) { alert("Eksik bilgi!"); return; }
            await fetch('/api/toplu-satis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert("Fatura kesildi!");
            sepet = []; guncelleSepet(); yukleStok(); yukleFaturalar();
        }

        async function yukleFaturalar() {
            const res = await fetch('/api/invoices');
            const data = await res.json();
            const liste = document.getElementById('fatura-listesi');
            liste.innerHTML = '';
            data.forEach(f => {
                liste.innerHTML += `<tr><td>${f.tarih}</td><td>${f.ad}</td><td class="text-xs">${f.parca_ad}</td><td class="font-bold">₺${f.toplam}</td><td><button onclick="sil('invoices','${f._id}')" class="text-red-400"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        async function yukleGiderler() {
            const res = await fetch('/api/expenses');
            const data = await res.json();
            const liste = document.getElementById('gider-listesi');
            liste.innerHTML = '';
            data.forEach(g => {
                liste.innerHTML += `<tr><td>${g.tarih}</td><td>${g.desc}</td><td>${g.cat}</td><td class="text-red-600 font-bold">₺${g.tutar}</td><td><button onclick="sil('expenses','${g._id}')" class="text-red-400"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        async function giderEkle() {
            const data = {
                tarih: document.getElementById('g-tarih').value,
                desc: document.getElementById('g-desc').value,
                cat: document.getElementById('g-cat').value,
                tutar: document.getElementById('g-tutar').value
            };
            await fetch('/api/expenses', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            closeModals(); yukleGiderler();
        }

        async function yukleMusteriler() {
            const res = await fetch('/api/customers');
            const data = await res.json();
            const liste = document.getElementById('musteri-listesi');
            liste.innerHTML = '';
            data.forEach(m => {
                liste.innerHTML += `<tr><td class="font-bold">${m.ad}</td><td>${m.tel}</td><td>${m.son_islem}</td><td><button class="text-blue-500"><i class="fas fa-eye"></i></button></td></tr>`;
            });
        }

        function closeModals() { 
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-parca-baslik').innerText = "Yeni Parça Ekle";
            // Inputları temizle
            document.querySelectorAll('#modal-parca input, #modal-parca textarea').forEach(i => i.value = '');
        }

        function tabloAra(tabloId, deger) {
            const rows = document.querySelectorAll(`#${tabloId} tbody tr`);
            rows.forEach(row => { row.style.display = row.innerText.toLowerCase().includes(deger.toLowerCase()) ? '' : 'none'; });
        }

        async function sil(col, id) {
            if(confirm('Silinsin mi?')) {
                await fetch(`/api/${col}/${id}`, {method: 'DELETE'});
                if(col === 'expenses') yukleGiderler();
                if(col === 'invoices') yukleFaturalar();
            }
        }

        async function resetFinance() {
            await fetch('/api/reset-finance', {method: 'POST'});
            location.reload();
        }

        function exportExcel(col) {
            fetch(`/api/${col}`).then(res => res.json()).then(data => {
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'text/plain'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `${col}_yedek.txt`;
                a.click();
            });
        }

        function triggerImport(type) { activeImportType = type; document.getElementById('import-file').click(); }

        async function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                await fetch(`/api/import/${activeImportType}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
