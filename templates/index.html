<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>ÖZCAN OTO | Yönetim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; display: flex; }
        .sidebar { background: #0f172a; min-height: 100vh; width: 280px; flex-shrink: 0; }
        .page-content { display: none; padding: 40px; width: 100%; height: 100vh; overflow-y: auto; }
        .active-section { display: block; }
        .sidebar-link { cursor: pointer; padding: 15px; color: #94a3b8; transition: 0.3s; }
        .sidebar-link:hover { background: #1e293b; color: white; }
        .sidebar-active { background: #f97316 !important; color: white !important; font-weight: bold; }
    </style>
</head>
<body>

    <aside class="sidebar text-white">
        <div class="p-8 border-b border-slate-800 text-center font-bold text-xl italic uppercase">ÖZCAN OTO</div>
        <nav class="mt-5">
            <div onclick="showPage('dashboard')" id="btn-dashboard" class="sidebar-link sidebar-active"><i class="fas fa-chart-line mr-2"></i> DASHBOARD</div>
            <div onclick="showPage('stok')" id="btn-stok" class="sidebar-link"><i class="fas fa-boxes mr-2"></i> PARÇA YÖNETİMİ</div>
            <div onclick="showPage('fatura')" id="btn-fatura" class="sidebar-link"><i class="fas fa-file-invoice mr-2"></i> FATURA KES</div>
        </nav>
    </aside>

    <main class="flex-1">
        <div id="page-dashboard" class="page-content active-section">
            <h2 class="text-3xl font-bold mb-8 uppercase">SİSTEM ÖZETİ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div onclick="exportToExcel('products')" class="bg-white p-8 rounded-2xl shadow-sm border-l-8 border-green-600 cursor-pointer hover:bg-green-50">
                    <h4 class="font-bold text-slate-500">ENVANTER RAPORU</h4>
                    <p class="text-xl font-black">EXCEL OLARAK İNDİR</p>
                </div>
            </div>
        </div>

        <div id="page-stok" class="page-content">
            <h2 class="text-2xl font-bold mb-6">STOK LİSTESİ</h2>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 font-bold text-slate-500">
                        <tr><th class="p-4">PARÇA ADI</th><th class="p-4 text-center">STOK</th><th class="p-4 text-right">FİYAT</th><th class="p-4 text-right">İŞLEM</th></tr>
                    </thead>
                    <tbody id="stok-list"></tbody>
                </table>
            </div>
        </div>
        
        <div id="page-fatura" class="page-content">
            <h2 class="text-2xl font-bold mb-6">SATIŞ İŞLEMİ</h2>
            <div class="bg-white p-8 rounded-xl shadow max-w-2xl">
                <div class="space-y-4">
                    <input id="fat-ad" type="text" placeholder="Müşteri Adı" class="w-full p-3 border rounded-lg outline-none">
                    <select id="fat-parca" class="w-full p-3 border rounded-lg outline-none"></select>
                    <input id="fat-adet" type="number" placeholder="Adet" class="w-full p-3 border rounded-lg outline-none">
                    <button onclick="faturaKes()" class="w-full bg-orange-600 text-white font-bold py-4 rounded-lg">SATIŞI ONAYLA</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        async function yukleStok() {
            const res = await fetch('/api/products');
            const data = await res.json();
            document.getElementById('stok-list').innerHTML = data.reverse().map(i => `
                <tr class="border-t">
                    <td class="p-4 font-bold uppercase">${i.name}</td>
                    <td class="p-4 text-center font-bold">${i.stock}</td>
                    <td class="p-4 text-right font-bold">₺${i.price}</td>
                    <td class="p-4 text-right"><button onclick="sil('${i._id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
            
            // Fatura sayfasındaki seçeneği de güncelle
            document.getElementById('fat-parca').innerHTML = data.map(i => `<option value="${i._id}">${i.name} (Stok: ${i.stock})</option>`).join('');
        }

        async function sil(id) {
            if(confirm('BU PARÇAYI SİLMEK İSTEDİĞİNİZE EMİN MİSİNİZ?')) {
                await fetch(`/api/products/${id}`, {method: 'DELETE'});
                yukleStok(); // Burada sadece listeyi yeniliyoruz, Dashboard'a atmıyor.
            }
        }

        async function faturaKes() {
            const data = {
                ad: document.getElementById('fat-ad').value,
                tel: "-",
                parcaId: document.getElementById('fat-parca').value,
                adet: document.getElementById('fat-adet').value,
                tarih: new Date().toLocaleString('tr-TR')
            };
            const res = await fetch('/api/fatura-kes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("SATIŞ BAŞARILI"); yukleStok(); }
        }

        async function exportToExcel(type) {
            const res = await fetch(`/api/${type}`);
            const data = await res.json();
            const bugun = new Date().toLocaleDateString('tr-TR');
            
            let rows = [["ÖZCAN OTO GÜNLÜK RAPOR - " + bugun], []];
            data.forEach(i => {
                rows.push(["PARÇA: " + i.name]);
                rows.push(["KOD: " + (i.code || "-")]);
                rows.push(["STOK: " + i.stock + " ADET"]);
                rows.push(["FİYAT: ₺" + i.price]);
                rows.push(["------------------"]);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Stok_Raporu");
            XLSX.writeFile(wb, `OzcanOto_Stok_${bugun}.xlsx`);
        }

        function showPage(p) {
            document.querySelectorAll('.page-content').forEach(x => x.classList.remove('active-section'));
            document.querySelectorAll('.sidebar-link').forEach(x => x.classList.remove('sidebar-active'));
            document.getElementById('page-' + p).classList.add('active-section');
            document.getElementById('btn-' + p).classList.add('sidebar-active');
            if(p === 'stok' || p === 'fatura') yukleStok();
        }
    </script>
</body>
</html>
